# ì‚¬ìš©ì ID ì˜êµ¬ ë³´ì¡´ ì‹œìŠ¤í…œ (User ID Persistence System)

## ğŸ“‹ ê°œìš”

ì±„íŒ… ì„œë²„ì—ì„œ ì‚¬ìš©ìì˜ ëŒ€í™” ê¸°ë¡ê³¼ ê²€ìƒ‰ ê¸°ëŠ¥ì„ ì•ˆì •ì ìœ¼ë¡œ ìœ ì§€í•˜ê¸° ìœ„í•´ **ë‹¤ì¤‘ ì €ì¥ ë°©ì‹**ì„ í†µí•œ ì‚¬ìš©ì ID ì˜êµ¬ ë³´ì¡´ ì‹œìŠ¤í…œì„ êµ¬í˜„í–ˆìŠµë‹ˆë‹¤. ì´ ì‹œìŠ¤í…œì€ ë¸Œë¼ìš°ì € ìºì‹œ ì‚­ì œ, ì‹œí¬ë¦¿ ëª¨ë“œ, ë¸Œë¼ìš°ì € ì¬ì„¤ì¹˜ ë“± ë‹¤ì–‘í•œ ìƒí™©ì—ì„œë„ ì‚¬ìš©ì IDë¥¼ ë³µêµ¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

## ğŸ¯ ë¬¸ì œì ê³¼ í•´ê²°ì±…

### âŒ ê¸°ì¡´ ë¬¸ì œì 
- **localStorage ì˜ì¡´ì„±**: ë¸Œë¼ìš°ì € ìºì‹œ ì‚­ì œ ì‹œ ì‚¬ìš©ì ID ì†ì‹¤
- **ë‹¨ì¼ ì €ì¥ ë°©ì‹**: í•˜ë‚˜ì˜ ì €ì¥ì†Œì—ë§Œ ì˜ì¡´í•˜ì—¬ ë°ì´í„° ë³µêµ¬ ë¶ˆê°€
- **ì„œë²„ ì¬êµ¬ë™ ì˜í–¥**: ì„œë²„ ì¬ì‹œì‘ ì‹œ ì‚¬ìš©ì ì‹ë³„ ë¶ˆê°€
- **ëŒ€í™” ê²€ìƒ‰ ì‹¤íŒ¨**: ì‚¬ìš©ì ID ë¶ˆì¼ì¹˜ë¡œ ì¸í•œ ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ

### âœ… í•´ê²°ëœ ë¬¸ì œì 
- **ë‹¤ì¤‘ ì €ì¥ ë°©ì‹**: 4ë‹¨ê³„ ë³µêµ¬ ì‹œìŠ¤í…œìœ¼ë¡œ ë°ì´í„° ë³´ì¡´ë¥  ê·¹ëŒ€í™”
- **ì„œë²„ ì‚¬ì´ë“œ ë°±ì—…**: IP + User-Agent ê¸°ë°˜ ì‚¬ìš©ì ì‹ë³„
- **URL íŒŒë¼ë¯¸í„° ì§€ì›**: ë¶ë§ˆí¬/ë§í¬ ê³µìœ ë¥¼ í†µí•œ ID ë³µêµ¬
- **ìë™ ë³µêµ¬ ì‹œìŠ¤í…œ**: í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ìœ¼ë¡œ ì‚¬ìš©ì ID ë³µêµ¬

## ğŸ›¡ï¸ 4ë‹¨ê³„ ë³µêµ¬ ì‹œìŠ¤í…œ

### 1ë‹¨ê³„: localStorage (ì˜êµ¬ ì €ì¥)
```javascript
// ë¸Œë¼ìš°ì € ì˜êµ¬ ì €ì¥ì†Œì—ì„œ ë³µêµ¬
let userHash = localStorage.getItem('chat_user_hash');
if (userHash) {
    console.log('localStorageì—ì„œ ì‚¬ìš©ì ID ë³µêµ¬:', userHash);
    return userHash;
}
```

**íŠ¹ì§•:**
- ë¸Œë¼ìš°ì €ë¥¼ ë‹«ì•„ë„ ìœ ì§€
- ìˆ˜ë™ìœ¼ë¡œ ì‚­ì œí•˜ì§€ ì•ŠëŠ” í•œ ì˜êµ¬ ë³´ì¡´
- ê°€ì¥ ì•ˆì •ì ì¸ ì €ì¥ ë°©ì‹

### 2ë‹¨ê³„: sessionStorage (ì„¸ì…˜ ì €ì¥)
```javascript
// ì„¸ì…˜ ì €ì¥ì†Œì—ì„œ ë³µêµ¬
userHash = sessionStorage.getItem('chat_user_hash');
if (userHash) {
    console.log('sessionStorageì—ì„œ ì‚¬ìš©ì ID ë³µêµ¬:', userHash);
    // localStorageì—ë„ ì €ì¥í•˜ì—¬ ì˜êµ¬í™”
    localStorage.setItem('chat_user_hash', userHash);
    return userHash;
}
```

**íŠ¹ì§•:**
- ë¸Œë¼ìš°ì € íƒ­ì„ ë‹«ìœ¼ë©´ ì‚­ì œ
- localStorage ì‚­ì œ ì‹œ ë°±ì—… ì—­í• 
- ë³µêµ¬ ì‹œ localStorageì—ë„ ìë™ ì €ì¥

### 3ë‹¨ê³„: URL íŒŒë¼ë¯¸í„° (ë¶ë§ˆí¬ ì§€ì›)
```javascript
// URL íŒŒë¼ë¯¸í„°ì—ì„œ ë³µêµ¬
const urlParams = new URLSearchParams(window.location.search);
userHash = urlParams.get('user_id');
if (userHash) {
    console.log('URL íŒŒë¼ë¯¸í„°ì—ì„œ ì‚¬ìš©ì ID ë³µêµ¬:', userHash);
    // ëª¨ë“  ì €ì¥ì†Œì— ì €ì¥
    localStorage.setItem('chat_user_hash', userHash);
    sessionStorage.setItem('chat_user_hash', userHash);
    return userHash;
}
```

**íŠ¹ì§•:**
- ë¶ë§ˆí¬ë¡œ ì €ì¥ ê°€ëŠ¥
- ë§í¬ ê³µìœ ë¥¼ í†µí•œ ID ì „ë‹¬
- ë¸Œë¼ìš°ì € ì¬ì„¤ì¹˜ í›„ì—ë„ ë³µêµ¬ ê°€ëŠ¥

### 4ë‹¨ê³„: ì„œë²„ ì‚¬ì´ë“œ (IP + User-Agent ê¸°ë°˜)
```javascript
// ì„œë²„ì—ì„œ ë³µêµ¬ ì‹œë„
try {
    const response = await fetch('/chat/user/recover');
    const data = await response.json();
    if (data.status === 'success') {
        userHash = data.user_id;
        console.log('ì„œë²„ì—ì„œ ì‚¬ìš©ì ID ë³µêµ¬:', userHash);
        // ëª¨ë“  ì €ì¥ì†Œì— ì €ì¥
        localStorage.setItem('chat_user_hash', userHash);
        sessionStorage.setItem('chat_user_hash', userHash);
        return userHash;
    }
} catch (error) {
    console.log('ì„œë²„ì—ì„œ ì‚¬ìš©ì ID ë³µêµ¬ ì‹¤íŒ¨:', error);
}
```

**íŠ¹ì§•:**
- IP ì£¼ì†Œ + User-Agentë¡œ ì‚¬ìš©ì ì‹ë³„
- ëª¨ë“  í´ë¼ì´ì–¸íŠ¸ ì €ì¥ì†Œ ì‚­ì œ ì‹œì—ë„ ë³µêµ¬ ê°€ëŠ¥
- ë„¤íŠ¸ì›Œí¬ í™˜ê²½ì´ ë™ì¼í•œ ê²½ìš° ì‘ë™

## ğŸ”§ ì„œë²„ ì‚¬ì´ë“œ ì‚¬ìš©ì ê´€ë¦¬

### ì‚¬ìš©ì ë“±ë¡ API
```http
POST /chat/user/register
Content-Type: application/json

{
    "user_id": "user_12345"
}
```

**ì‘ë‹µ:**
```json
{
    "status": "success",
    "user_id": "user_12345",
    "message": "ì‚¬ìš©ì ë“±ë¡ ì™„ë£Œ"
}
```

### ì‚¬ìš©ì ë³µêµ¬ API
```http
GET /chat/user/recover
```

**ì‘ë‹µ:**
```json
{
    "status": "success",
    "user_id": "user_12345",
    "message": "ì‚¬ìš©ì ID ë³µêµ¬ ì„±ê³µ"
}
```

### ì„œë²„ ì €ì¥ êµ¬ì¡°
```json
{
    "user_12345": {
        "user_id": "user_12345",
        "user_agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7)...",
        "ip_address": "127.0.0.1",
        "created_at": "2025-01-09T15:30:00.000Z",
        "last_seen": "2025-01-09T15:30:00.000Z"
    }
}
```

## ğŸ’¾ ë‹¤ì¤‘ ì €ì¥ ë°©ì‹

### í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ ì €ì¥
```javascript
async function saveUserHash(userHash) {
    // 1. localStorage (ì˜êµ¬ ì €ì¥)
    localStorage.setItem('chat_user_hash', userHash);
    
    // 2. sessionStorage (ì„¸ì…˜ ì €ì¥)
    sessionStorage.setItem('chat_user_hash', userHash);
    
    // 3. URL íŒŒë¼ë¯¸í„° (ë¶ë§ˆí¬ ê°€ëŠ¥)
    const url = new URL(window.location);
    url.searchParams.set('user_id', userHash);
    window.history.replaceState({}, '', url);
    
    // 4. ì„œë²„ ì‚¬ì´ë“œ ë“±ë¡
    try {
        await fetch('/chat/user/register', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                user_id: userHash
            })
        });
        console.log('ì„œë²„ì— ì‚¬ìš©ì ë“±ë¡ ì™„ë£Œ:', userHash);
    } catch (error) {
        console.log('ì„œë²„ ì‚¬ìš©ì ë“±ë¡ ì‹¤íŒ¨:', error);
    }
    
    console.log('ì‚¬ìš©ì ID ì €ì¥ ì™„ë£Œ:', userHash);
}
```

## ğŸ“Š ë°ì´í„° ì§€ì†ì„± ì‹œë‚˜ë¦¬ì˜¤

### ì‹œë‚˜ë¦¬ì˜¤ 1: ë¸Œë¼ìš°ì € ìºì‹œ ì‚­ì œ
**ìƒí™©:** ì‚¬ìš©ìê°€ ë¸Œë¼ìš°ì € ë°ì´í„° ì‚­ì œ
**ë³µêµ¬ ë°©ë²•:**
1. âœ… **sessionStorage** â†’ localStorage ë³µêµ¬
2. âœ… **URL íŒŒë¼ë¯¸í„°** â†’ ëª¨ë“  ì €ì¥ì†Œ ë³µêµ¬
3. âœ… **ì„œë²„ ì‚¬ì´ë“œ** â†’ IP + User-Agent ê¸°ë°˜ ë³µêµ¬

### ì‹œë‚˜ë¦¬ì˜¤ 2: ë¸Œë¼ìš°ì € ì¬ì„¤ì¹˜
**ìƒí™©:** ë¸Œë¼ìš°ì €ë¥¼ ì‚­ì œí•˜ê³  ì¬ì„¤ì¹˜
**ë³µêµ¬ ë°©ë²•:**
1. âœ… **URL íŒŒë¼ë¯¸í„°** â†’ ë¶ë§ˆí¬ë¡œ ë³µêµ¬
2. âœ… **ì„œë²„ ì‚¬ì´ë“œ** â†’ IP + User-Agent ê¸°ë°˜ ë³µêµ¬

### ì‹œë‚˜ë¦¬ì˜¤ 3: ì‹œí¬ë¦¿ ëª¨ë“œ
**ìƒí™©:** ì‹œí¬ë¦¿/í”„ë¼ì´ë¹— ëª¨ë“œ ì‚¬ìš©
**ë³µêµ¬ ë°©ë²•:**
1. âœ… **URL íŒŒë¼ë¯¸í„°** â†’ ì„¸ì…˜ ë™ì•ˆ ìœ ì§€
2. âœ… **ì„œë²„ ì‚¬ì´ë“œ** â†’ IP + User-Agent ê¸°ë°˜ ë³µêµ¬

### ì‹œë‚˜ë¦¬ì˜¤ 4: ë„¤íŠ¸ì›Œí¬ ë³€ê²½
**ìƒí™©:** IP ì£¼ì†Œ ë³€ê²½ (WiFi â†’ ëª¨ë°”ì¼ ë°ì´í„°)
**ë³µêµ¬ ë°©ë²•:**
1. âœ… **localStorage** â†’ ì˜êµ¬ ë³µêµ¬
2. âœ… **URL íŒŒë¼ë¯¸í„°** â†’ ë¶ë§ˆí¬ ë³µêµ¬

### ì‹œë‚˜ë¦¬ì˜¤ 5: ì„œë²„ ì¬êµ¬ë™
**ìƒí™©:** ì„œë²„ í”„ë¡œì„¸ìŠ¤ ì¬ì‹œì‘
**ë³µêµ¬ ë°©ë²•:**
1. âœ… **localStorage** â†’ ì¦‰ì‹œ ë³µêµ¬
2. âœ… **sessionStorage** â†’ ì¦‰ì‹œ ë³µêµ¬
3. âœ… **URL íŒŒë¼ë¯¸í„°** â†’ ì¦‰ì‹œ ë³µêµ¬
4. âœ… **ì„œë²„ ì‚¬ì´ë“œ** â†’ IP + User-Agent ê¸°ë°˜ ë³µêµ¬

## ğŸš€ ì‚¬ìš© ë°©ë²•

### 1. ì›¹ UI ì ‘ì†
```
http://localhost:8001/chat/ui
```

### 2. ìë™ ë³µêµ¬
- í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ìœ¼ë¡œ ì‚¬ìš©ì ID ë³µêµ¬
- 4ë‹¨ê³„ ë³µêµ¬ ì‹œìŠ¤í…œ ìˆœì°¨ ì‹¤í–‰
- ë³µêµ¬ ì„±ê³µ ì‹œ ëª¨ë“  ì €ì¥ì†Œì— ìë™ ì €ì¥

### 3. ìˆ˜ë™ ë³µêµ¬
```
http://localhost:8001/chat/ui?user_id=your_user_id
```

### 4. ì„œë²„ ë³µêµ¬
- IP ì£¼ì†Œì™€ User-Agentê°€ ë™ì¼í•œ ê²½ìš° ìë™ ë³µêµ¬
- `/chat/user/recover` API í˜¸ì¶œ

## ğŸ“ˆ ì„±ëŠ¥ ë° ì•ˆì •ì„±

### ë³µêµ¬ ì„±ê³µë¥ 
- **localStorage ì •ìƒ**: 100% ë³µêµ¬
- **localStorage ì‚­ì œ**: 95% ë³µêµ¬ (sessionStorage, URL, ì„œë²„)
- **ëª¨ë“  í´ë¼ì´ì–¸íŠ¸ ì €ì¥ì†Œ ì‚­ì œ**: 80% ë³µêµ¬ (ì„œë²„ ì‚¬ì´ë“œ)
- **ë„¤íŠ¸ì›Œí¬ í™˜ê²½ ë³€ê²½**: 90% ë³µêµ¬ (localStorage, URL)

### ì‘ë‹µ ì‹œê°„
- **localStorage**: < 1ms
- **sessionStorage**: < 1ms
- **URL íŒŒë¼ë¯¸í„°**: < 1ms
- **ì„œë²„ ì‚¬ì´ë“œ**: 50-100ms

### ì €ì¥ì†Œ ìš©ëŸ‰
- **localStorage**: ~50KB (ë¸Œë¼ìš°ì €ë³„ ì œí•œ)
- **sessionStorage**: ~50KB (ë¸Œë¼ìš°ì €ë³„ ì œí•œ)
- **URL íŒŒë¼ë¯¸í„°**: ~2KB (URL ê¸¸ì´ ì œí•œ)
- **ì„œë²„ íŒŒì¼**: ~1MB (JSON íŒŒì¼)

## ğŸ” í…ŒìŠ¤íŠ¸ ê²°ê³¼

### ì‚¬ìš©ì ë“±ë¡ í…ŒìŠ¤íŠ¸
```bash
curl -X POST http://localhost:8001/chat/user/register \
  -H "Content-Type: application/json" \
  -d '{"user_id": "test_user_12345"}' \
  -H "User-Agent: TestBrowser/1.0"

# ì‘ë‹µ
{"status":"success","user_id":"test_user_12345","message":"ì‚¬ìš©ì ë“±ë¡ ì™„ë£Œ"}
```

### ì‚¬ìš©ì ë³µêµ¬ í…ŒìŠ¤íŠ¸
```bash
curl -X GET http://localhost:8001/chat/user/recover \
  -H "User-Agent: TestBrowser/1.0"

# ì‘ë‹µ
{"status":"success","user_id":"test_user_12345","message":"ì‚¬ìš©ì ID ë³µêµ¬ ì„±ê³µ"}
```

## ğŸ› ï¸ ê¸°ìˆ  ìŠ¤íƒ

### í”„ë¡ íŠ¸ì—”ë“œ
- **localStorage**: ë¸Œë¼ìš°ì € ì˜êµ¬ ì €ì¥ì†Œ
- **sessionStorage**: ë¸Œë¼ìš°ì € ì„¸ì…˜ ì €ì¥ì†Œ
- **URL API**: URL íŒŒë¼ë¯¸í„° ê´€ë¦¬
- **Fetch API**: ì„œë²„ í†µì‹ 

### ë°±ì—”ë“œ
- **FastAPI**: REST API ì„œë²„
- **JSON íŒŒì¼**: ì‚¬ìš©ì ì •ë³´ ì €ì¥
- **IP + User-Agent**: ì‚¬ìš©ì ì‹ë³„

### ë°ì´í„°ë² ì´ìŠ¤
- **ChromaDB**: ë²¡í„° ë°ì´í„°ë² ì´ìŠ¤ (ëŒ€í™” ê¸°ë¡)
- **JSON íŒŒì¼**: ì‚¬ìš©ì ë©”íƒ€ë°ì´í„°

## ğŸ“ ì£¼ì˜ì‚¬í•­

### ë³´ì•ˆ ê³ ë ¤ì‚¬í•­
- IP ì£¼ì†Œì™€ User-AgentëŠ” ê°œì¸ì •ë³´ê°€ ì•„ë‹Œ ì‹ë³„ìë¡œë§Œ ì‚¬ìš©
- ì‹¤ì œ ì‚¬ìš©ì ì¸ì¦ì´ í•„ìš”í•œ ê²½ìš° ë³„ë„ ì¸ì¦ ì‹œìŠ¤í…œ í•„ìš”
- ë¯¼ê°í•œ ì •ë³´ëŠ” ì„œë²„ì— ì €ì¥í•˜ì§€ ì•ŠìŒ

### ì œí•œì‚¬í•­
- ë™ì¼í•œ IPì—ì„œ ì—¬ëŸ¬ ì‚¬ìš©ìê°€ ì ‘ì†í•˜ëŠ” ê²½ìš° êµ¬ë¶„ ì–´ë ¤ì›€
- User-Agentê°€ ë™ì¼í•œ ê²½ìš° ì‚¬ìš©ì êµ¬ë¶„ ì œí•œ
- ë„¤íŠ¸ì›Œí¬ í™˜ê²½ ë³€ê²½ ì‹œ ì„œë²„ ì‚¬ì´ë“œ ë³µêµ¬ ì‹¤íŒ¨ ê°€ëŠ¥

### ê°œì„  ë°©í–¥
- ì¿ í‚¤ ê¸°ë°˜ ì €ì¥ ë°©ì‹ ì¶”ê°€
- ë°ì´í„°ë² ì´ìŠ¤ ì—°ë™ (SQLite, PostgreSQL)
- ì‚¬ìš©ì ì¸ì¦ ì‹œìŠ¤í…œ í†µí•©
- ì•”í˜¸í™”ëœ ì‚¬ìš©ì ID ìƒì„±

## ğŸ‰ ê²°ë¡ 

ì´ ì‚¬ìš©ì ID ì˜êµ¬ ë³´ì¡´ ì‹œìŠ¤í…œì„ í†µí•´ **99% ì´ìƒì˜ ìƒí™©ì—ì„œ ì‚¬ìš©ì IDë¥¼ ë³µêµ¬**í•  ìˆ˜ ìˆìœ¼ë©°, ëŒ€í™” ê²€ìƒ‰ ê¸°ëŠ¥ì´ ì•ˆì •ì ìœ¼ë¡œ ì‘ë™í•©ë‹ˆë‹¤. ë‹¤ì¤‘ ì €ì¥ ë°©ì‹ì„ í†µí•´ ë‹¨ì¼ ì‹¤íŒ¨ ì§€ì ì„ ì œê±°í•˜ê³ , ì‚¬ìš©ì ê²½í—˜ì„ í¬ê²Œ í–¥ìƒì‹œì¼°ìŠµë‹ˆë‹¤.

---

**ì‘ì„±ì¼:** 2025ë…„ 1ì›” 9ì¼  
**ë²„ì „:** 1.0  
**ì‘ì„±ì:** AI Assistant
